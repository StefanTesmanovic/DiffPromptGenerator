<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Code Diff Prompt Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7fafc;
            color: #1a202c; 
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            text-align: center;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            color: #2d3748;
        }

        p {
            font-size: 1.1em;
            color: #4a5568;
        }

        .editor-column {
            flex: 1;
            text-align: left;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            box-sizing: border-box;
        }

        button {
            background-color: #3182ce;
            color: white;
            font-weight: bold;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }

        #submit-btn {
            float: right;
        }

        #generate-btn {
            display: none;
            float: right;
        }

        button:hover {
            background-color: #2b6cb0;
        }

        #modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
        }

        #modal-panel {
            background-color: #fefefe;
            margin: 50px auto; 
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        #close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
        }

        #close-btn:hover,
        #close-btn:focus {
            color: black;
        }
        
        .modal-content {
            padding: 20px;
            overflow-y: auto;
        }

        #prompt-output {
            font-family: 'Courier New', Courier, monospace;
            background-color: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word; 
            text-align: left;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
            background-color: #f7fafc;
            text-align: right;
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        #copy-btn {
            background-color: #4a5568; 
        }
        
        #copy-btn:hover {
            background-color: #2d3748;
        }
        
        #response { 
            font-family: 'Courier New', Courier, monospace;
            background-color: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word; 
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Code Diff Prompt Generator</h1>

            <label for="apiKey">Paste Your Google AI Studio Key:</label>
            <input type="password" id="apiKey" style="width: 100%;">
            <br><br>

            <p>Paste your original code, submit it, and edit it before generating a prompt.</p>
        </header>

        <div class="editor-column">
            <label id="label" for="original-code">Paste original code here</label>
            <button id="submit-btn">
                Submit code
            </button>
            <button id="generate-btn">
                Generate LLM Prompt
            </button>
            <textarea id="original-code" placeholder="Paste your original code here..."></textarea>
        </div>
    </div>

    <div id="modal">
        <div id="modal-panel">
            <div class="modal-header">
                <h2>Your LLM Prompt</h2>
                <button id="close-btn">&times;</button>
            </div>
            <div class="modal-content">
                <pre id="prompt-output"></pre>
                <button id="promptBtn">Test Prompt with Gemini API</button>
                <pre id="response">Press the button if you want the LLM answer</pre>
            </div>
            <div class="modal-footer">
                <button id="copy-btn">Copy Prompt to Clipboard</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
        const originalCodeEl = document.getElementById('original-code');
        const editedCodeEl = document.getElementById('edited-code');
        const generateBtn = document.getElementById('generate-btn');
        const modal = document.getElementById('modal');
        const modalPanel = document.getElementById('modal-panel');
        const closeBtn = document.getElementById('close-btn');
        const copyBtn = document.getElementById('copy-btn');
        const promptOutputEl = document.getElementById('prompt-output');
        const labela = document.getElementById('label');
        const submitBtn = document.getElementById('submit-btn');
        const responseEl = document.getElementById("response");

        var originalCode = "";

        function showPrompt() {
            const originalText = originalCode;
            const editedText = originalCodeEl.value;
            
            const patch = Diff.createPatch('code', originalText, editedText);

            const promptTemplate = `
You are an expert code reviewer, known for concise and precise reviews. You work with exceptional engineers that understand instantly from concise bullet points.Your job is to analyze the code and inform about readability, complexity and differences with respect to readability and complexity.
Use markdown formatting, use the least possible number of new lines.
Here is the original code:
${originalText}
Here is the diff of the changes:
${patch}

`;          // I noticed that the model was responding with messages that are too 
            // long and waste time. Because of that I tried to shorten them and preserve 
            // information by informing the model of the environment and role instead of giving a word limit 

            promptOutputEl.textContent = promptTemplate.trim();
            modal.style.display = 'block';
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        function copyToClipboard() {
            const textToCopy = promptOutputEl.textContent;

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            document.body.appendChild(tempTextArea);
            
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
            } catch (err) {
                console.error('Failed to copy text: ', err);
                copyBtn.textContent = 'Failed to Copy';
            }
            document.body.removeChild(tempTextArea);
        }

        function handleSubmit() {
            labela.textContent = "Code submitted! You can now edit it.";
            originalCode = originalCodeEl.value;
            submitBtn.style.display = 'none';
            generateBtn.style.display = 'unset';
        }

        generateBtn.addEventListener('click', showPrompt);
        closeBtn.addEventListener('click', closeModal);
        submitBtn.addEventListener('click', handleSubmit);
        
        copyBtn.addEventListener('click', copyToClipboard);
        
        async function displayMarkdown(markdownText) {
            const html = marked(markdownText);
            responseEl.innerHTML = `<div id="output">${html}</div>`;
        }

        document.getElementById("promptBtn").addEventListener("click", async () => {
            const apiKey = document.getElementById("apiKey").value;
            const prompt = document.getElementById("prompt-output").textContent;
            
            
            if (!apiKey) {
                responseEl.textContent = "Error: Please paste your API key first.";
                return;
            }

            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";
            responseEl.textContent = "Thinking...";

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-goog-api-key": apiKey
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    }),
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                displayMarkdown(text);
            } catch (error) {
                console.error("Error:", error);
                responseEl.textContent = "Error fetching response. Check console for details.";
            }
        });
    </script>

</body>
</html>

